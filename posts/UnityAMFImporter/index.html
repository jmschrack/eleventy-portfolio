<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity3D AMF-Importer</title>
    <meta name="Description" content="Import &quot;Adjutant Model Files&quot; (.AMF) into Unity3D">
	<!-- <link rel="stylesheet" href="/css/index.css"> -->
	<link rel="stylesheet" href="/css/w3.css">
	<!--  -->
    
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css"> 
	
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Jonathan Schrack">
	<link rel="icon" type="image/png" href="/img/favicon.ico">
  </head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
<style>
body,h1,h2,h3,h4,h5 {font-family: "Poppins", sans-serif}
body {font-size:16px;}
.w3-half img{margin-bottom:-6px;margin-top:16px;opacity:0.8;cursor:pointer}
.w3-half img:hover{opacity:1}
</style>
  <body>
    <nav class="w3-sidebar w3-red w3-collapse w3-top w3-large w3-padding" style="z-index:3;width:300px;font-weight:bold;" id="mySidebar">
	<a href="javascript:void(0)" onclick="w3_close()" class="w3-button w3-hide-large w3-display-topleft" style="width:100%;font-size:22px">Close Menu</a>
      <h1 class="home">Jonathan Schrack</h1>
      <ul class="w3-bar-block">
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/">Home</a></li>
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/posts/">Archive</a></li>
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/portfolio/">Portfolio</a></li>
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/about/">About Me</a></li>
      </ul>
    </nav>
	
	<header class="w3-container w3-top w3-hide-large w3-red w3-xlarge w3-padding">
	  <a href="javascript:void(0)" class="w3-button w3-red w3-margin-right" onclick="w3_open()">☰</a>
	  <span>Jonathan Schrack</span>
	</header>
	
	<div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>
	
    <main class="tmpl-post w3-main" style="margin-left:340px;margin-right:40px">
		
		<div class="w3-container">
			<h1></h1>
<div class="w3-container" style="margin-top:80px" id="showcase">
			<h1 class="w3-xxxlarge w3-text-red"><b>Unity3D AMF-Importer</b></h1>
			<hr style="width:50px;border:5px solid red" class="w3-round">
		</div>
<p><img src="/img/AMFImporter.png" alt="alt text" title="Adjutant to Unity"></p>
<h2 id="the-impetus">The impetus <a class="direct-link" href="#the-impetus">#</a></h2>
<p>I wanted to test the efficiency of rendering a FPS multiplayer map on some low end hardware. So I started to make a map when I realized, why waste time on a theoretical map, when I could use an existing map from an FPS? Then I recalled that I used to play a lot of Halo:CE in college.  Not &quot;Combat Evolved&quot; but &quot;<em>Custom Edition</em>&quot;.</p>
<p>Custom Edition had tools that allowed the community to create custom levels, maps, guns, etc. But I didn't want to use someone else' map; I wanted to use one of the official maps as a benchmark for my performance test. So I did some research and came across a fan made tool called &quot;Adjutant&quot; that lets you extract geometry and textures from the Halo map files. Even better it supported Halo 3 assets! So I open up &quot;Isolation&quot; multiplayer map from Halo 3. Extract the textures as PNGs and extract the model as... AMF?</p>
<h2 id="down-the-rabbit-hole...">Down the rabbit hole... <a class="direct-link" href="#down-the-rabbit-hole...">#</a></h2>
<p>So the Adjutant mod team had created their own model file format to extract as.  They then provided an import script plugin for 3DS...2005.  I don't own 3DS Max, much less the older precursor. So I started investigating if anyone had made a Blender plugin that could import AMF.  No one had. Most of the documentation and mod posts I was finding for Halo:CE were circa 2003 at best. However, by chance I ran across a forum post dated late 2018 of someone talking about making a Blender plugin.</p>
<p>Huge shoutout to Shelley and the rest of the folks over on the Reclaimers discord. Shelley had a decompiled version of the 3DS importer plugin. With this, I was able to write my own C# importer to allow Unity to import AMF files natively as if they were 3D models! ...almost.</p>
<p><img src="/img/IsolationFubar.png" alt="alt text" title="Isolation messed up"></p>
<h2 id="geometry">Geometry <a class="direct-link" href="#geometry">#</a></h2>
<p>Huge thanks to Kim Duran &amp; <a href="https://www.linkedin.com/in/hunter-gore-9960b0148">Hunter Gore</a> for helping me with matrix transform math!</p>
<p>Halo/3DS uses a right handed, z-up coordinate system, while Unity uses a left-handed Y-up system.  Converting between the two ended up being slightly trickier than it should have been. As the coordinates would be extracted from the raw AMF file, but then certain modifiers and transforms would be applied based on the geometry name.<br>
<img src="/img/IsolationFubar2.png" alt="alt text" title="Isolation partially correct"></p>
<p>Thankfully, geometry falls into two catergories of terrain or instances.<br>
<img src="/img/IsolationFixedGeo.png" alt="alt text" title="Isolation slightly less messed up"><br>
...But what's up with the crushed blacks?</p>
<h2 id="materials">Materials <a class="direct-link" href="#materials">#</a></h2>
<p>The AMF file format has data in it for setting up textures and materials into the shaders. Every material has an array of textures, colors, and normal maps. Unfortunately the 3DS importer script does not support anything other than a basic diffuse set up. However, looking at the textures referenced, the AMF file would preserve indexes and leave in null fields. So a pattern can be observed with what texture indexes are albedo, normals, color change, and lighting.<br>
That get's us about 75% of the way there, but we still have these weird, crushed black looking materials.<br>
<img src="/img/crushedBlackRock.png" alt="alt text" title="Rocks with Crushed Black"><br>
That ends up being an easy fix.  The textures have been pre-converted to linear colorspace, but by default Unity (and everything else) imports the texture as Gamma and then converts to linear. So changing the texture's sRGB setting to false fixed the colors and gets shadows to play nice as well!<br>
<img src="/img/RocksInShade.png" alt="alt text" title="Fixed rocks"></p>
<h2 id="rigged-importing">Rigged Importing <a class="direct-link" href="#rigged-importing">#</a></h2>
<p>It even works with rigged meshes, but that was whole other process of figuring out the right transforms to apply at certain steps. I saved a few screenshots of the more interesting steps in the process.</p>
<p>The correct skeleton is on the left. That wadded up ball of lines? That's the imported skeleton.<br>
<img src="/img/MCRig1.png" alt="alt text" title="Wadded up ball of skeleton"></p>
<p>Skeleton is looking right, except it took a long walk off a short cliff.<br>
<img src="/img/MCRig2.png" alt="alt text" title="Skeleton sleeping on the job"></p>
<p>Skeleton is right, but the 3D mesh is not?<br>
<img src="/img/MCRig3.png" alt="alt text" title="Almost there"></p>
<p>Skeleton and mesh imports properly, except a basic idle animation results in MasterChief about to drop the hottest rap album of 2020.<br>
<img src="/img/MCRigAnim1.gif" alt="alt text" title="MC is bit too gangsta"></p>
<p>Easy enough, adjusting MC to be in a T-Pose corrects the avatar's limb rotations.<br>
<img src="/img/MCRigAnimFinal.gif" alt="alt text" title="perfect"></p>
<h1 id="the-end-result">The End Result <a class="direct-link" href="#the-end-result">#</a></h1>
<p>Is a pretty servicable importer for AMF files into Unity! It's not perfect, but neither is AMF.</p>
<p>The full source code is on GitHub:<br>
<a href="https://github.com/jmschrack/Unity3D-AMFImporter">https://github.com/jmschrack/Unity3D-AMFImporter</a></p>
<h1 id="wait-what-about-that-render-test%3F">Wait what about that Render test? <a class="direct-link" href="#wait-what-about-that-render-test%3F">#</a></h1>
<p>4 player splitscreen hit max frame rate 30FPS on an android tablet. (Screen is locked at VSync. Judging by the CPU stats, it could feasible hit 50+FPS without VSync)</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/7W2QDMUuvdY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p><a href="/">← Home</a></p>

		</div>
    </main>

    <footer></footer>
	<script>
// Script to open and close sidebar
function w3_open() {
  document.getElementById("mySidebar").style.display = "block";
  document.getElementById("myOverlay").style.display = "block";
}
 
function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
  document.getElementById("myOverlay").style.display = "none";
}
</script>
    <!-- Current page: /posts/UnityAMFImporter/ -->
  </body>
</html>
