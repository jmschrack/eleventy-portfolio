<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unleash the power of WebGL and Unity</title>
    <meta name="Description" content="How to do callbacks in Unity WebGL and other tricks">
	<!-- <link rel="stylesheet" href="/css/index.css"> -->
	<link rel="stylesheet" href="/css/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
	<!--  -->
    
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css"> 
	
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Jonathan Schrack">
	<link rel="icon" type="image/png" href="/img/favicon.ico">
  </head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
<style>
body,h1,h2,h3,h4,h5 {font-family: "Poppins", sans-serif}
body {font-size:16px;}
.w3-half img{margin-bottom:-6px;margin-top:16px;opacity:0.8;cursor:pointer}
.w3-half img:hover{opacity:1}
</style>
  <body>
    <nav class="w3-sidebar w3-red w3-collapse w3-top w3-large w3-padding" style="z-index:3;width:300px;font-weight:bold;" id="mySidebar">
	<a href="javascript:void(0)" onclick="w3_close()" class="w3-button w3-hide-large w3-display-topleft" style="width:100%;font-size:22px">Close Menu</a>
      <div class="w3-padding-64"><h1 class="home">Jonathan Schrack</h1></div>
      <ul class="w3-bar-block">
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/">Home</a></li>
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/portfolio/">Portfolio</a></li>
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/about/">About Me</a></li>
        <li class="nav-item " ><a class="w3-bar-item w3-button w3-hover-white" href="/posts/">Archive</a></li>
      </ul>
    </nav>
	
	<header class="w3-container w3-top w3-hide-large w3-red w3-xlarge w3-padding">
	  <a href="javascript:void(0)" class="w3-button w3-red w3-margin-right" onclick="w3_open()">☰</a>
	  <span>Jonathan Schrack</span>
	</header>
	
	<div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>
	
    <main class="tmpl-post w3-main" style="margin-left:340px;margin-right:40px">
		
		<div class="w3-container">
			<script src="https://unpkg.com/prismjs@1.22.0/components/prism-core.min.js"></script>
	<script src="https://unpkg.com/prismjs@1.22.0/plugins/autoloader/prism-autoloader.min.js"></script>
<h1></h1>
<div class="w3-container" style="margin-top:80px" id="showcase">
			<h1 class="w3-xxxlarge w3-text-red"><b>Unleash the power of WebGL and Unity</b></h1>
			
			<hr style="width:50px;border:5px solid red" class="w3-round"><time class="postlist-date" datetime="Invalid DateTime">20 Jul 2020</time></h1>
		</div>
<div class="w3-container">
<p><a href="https://docs.unity3d.com/Manual/webgl-interactingwithbrowserscripting.html">Here's Unity's current documentation on interacting with Javascript</a><br>
This covers basic function calling and marshalling strings, but what about callbacks? If you've ever used Javascript, you know how much it loves callbacks. Unfortunately at the time of writing, there isn't any good documentation on how to work with javascript callbacks inside of Unity's WebGL builds with C#. So let's fix that.</p>
<blockquote>
<p>If you're coming from Unity and C# with little Javascript experience, you might have heard callbacks referred to as &quot;delegates&quot; or &quot;Actions.&quot;  Still not ringing a bell?  If you've used a UI button in Unity, the &quot;OnClick&quot; field is a callback!</p>
</blockquote>
<h1 id="topics">Topics <a class="direct-link" href="#topics">#</a></h1>
<ul>
<li><a href="#pass-a-c%23-callback-to-javascript">Pass a C# callback to Javascript</a></li>
<li><a href="#pass-a-javascript-callback-to-c%23">Pass a Javascript callback to C#</a></li>
<li><a href="#call-external-javascript-on-the-web-page">Call external Javascript on the web page.</a></li>
<li><a href="#creating-global-hooks-for-external-javascript-to-use">Creating global hooks for external Javascript to use</a></li>
<li><a href="#wrapping-up">Common Pitfalls</a></li>
</ul>
<p>Note: Web browsers only run Javascript or WebASM.  However, in Unity we code in C# which then gets compiled and converted to WebASM, and in order to avoid confusion, I'll often refer to things as C# instead of WebASM.</p>
<h1 id="pass-a-c%23-callback-to-javascript">Pass a C# callback to Javascript <a class="direct-link" href="#pass-a-c%23-callback-to-javascript">#</a></h1>
<h2 id="on-the-c%23-side">On the C# side <a class="direct-link" href="#on-the-c%23-side">#</a></h2>
<p>This is pretty straight forward for C# as the runtime will automatically marshal data for us.  &quot;Marshalling&quot; is the term for converting the data to another format and is necessary as we pass data from C# (technically WebASM) to Javascript and back.  Effectively, these two languages are isolated from each other in memory, but Interops allows these two transfer data and execution to and from each other.</p>
<p>Let's look at a C# sample:<br>
(JSAPI.cs)</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">AOT</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JSAPI</span><span class="token punctuation">{</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"__Internal"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">JSExample</span><span class="token punctuation">(</span><span class="token class-name">Action</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MonoPInvokeCallback</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Action</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DefaultCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//This fires from javascript</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">YourMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">JSExample</span><span class="token punctuation">(</span>DefaultCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Let's break this down:<br>
We declare our Javascript function called &quot;JSExample&quot;  as taking an &quot;Action&quot; reference. This is our function pointer that will get passed to Javascript.</p>
<p>We then declare a <strong>static</strong> function and mark it with <code>[MonoPInvokeCallback(typeof(Action))]</code> which as you can probably guess, will tell the compiler to generate a function pointer that matches type &quot;Action&quot;.  <em>(Why do we use a static callback function? We'll get to that later.)</em></p>
<p>Lastly, we can then call the Javascript function and pass in our static callback.</p>
<h2 id="on-the-javascript-side">On the Javascript side <a class="direct-link" href="#on-the-javascript-side">#</a></h2>
<p>This is where things start to get tricky. Fortunately, it's a lot of boilerplate code.</p>
<p>First off, to call a C# function from a Javascript function you want to use:</p>
<pre class="language-js"><code class="language-js">Runtime<span class="token punctuation">.</span><span class="token function">dynCall</span><span class="token punctuation">(</span>signature<span class="token punctuation">,</span>functionPtr<span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>signature</strong>: (string) return type followed by each argument type.</p>
<p>v - void<br>
i - int<br>
f - float<br>
d - double</p>
<p>example:<br>
<em>public static void SomeCallback(int id, string data)</em><br>
has the signature string:<br>
<em>&quot;vii&quot;</em><br>
(Why do string parameters use int? Because we copy the string to C# memory and then pass the pointer in. C# will auto-marshal this as a string for us!)</p>
<p><strong>functionPtr</strong>: the C# function we want to call</p>
<p><strong>arguments</strong>: (array) the parameters to pass to the C# function</p>
<p>In practice, it looks like this:<br>
(example.jslib)</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> myLib<span class="token operator">=</span><span class="token punctuation">{</span>
    $dependencies<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">JSExample</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">functionPtr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Runtime<span class="token punctuation">.</span><span class="token function">dynCall</span><span class="token punctuation">(</span><span class="token string">"v"</span><span class="token punctuation">,</span>functionPtr<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">autoAddDeps</span><span class="token punctuation">(</span>myLib<span class="token punctuation">,</span><span class="token string">'$dependencies'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mergInto</span><span class="token punctuation">(</span>LibraryManager<span class="token punctuation">.</span>library<span class="token punctuation">,</span>myLib<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>Sanity Check:  Your Javascript function name must match what you called your static extern function in C#, in this case &quot;JSExample&quot;</p>
</blockquote>
<p>Seems simple so far?</p>
<h1 id="pass-a-javascript-callback-to-c%23">Pass a Javascript callback to C# <a class="direct-link" href="#pass-a-javascript-callback-to-c%23">#</a></h1>
<p>This could be a bit hacky. Unity uses &quot;Emscripten&quot; as part of it's toolchain to convert your C# to WASM. As of Jan2019, a helper function was added to Emscripten that wraps a Javascript function as invokable method pointers. However, depending on your version of Unity, you may or may not have that update. We'll cover that first, but if you are stuck on an older version, we'll cover how to DIY your own workaround.</p>
<h2 id="on-the-javascript-side-(emscripten-v1.38.26-or-higher)">On the Javascript side (Emscripten v1.38.26 or higher) <a class="direct-link" href="#on-the-javascript-side-(emscripten-v1.38.26-or-higher)">#</a></h2>
<p>This will look similar to what we did above.</p>
<pre class="language-js"><code class="language-js">Runtime<span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span>jsFunction<span class="token punctuation">,</span>signature<span class="token punctuation">)</span><span class="token operator">:</span>IntPtr</code></pre>
<p><strong>jsFunction</strong>: (function) The Javascript function you want to wrap as a C# method.<br>
<strong>signature</strong>: (string) return type followed by each argument type. This follows the same rules as dynCall mentioned above.<br>
<strong>return:IntPtr</strong>: (int) the invokable pointer we can pass to C#.</p>
<p>In practice, looks like this:<br>
(example.jslib)</p>
<pre class="language-js"><code class="language-js"><span class="token comment">//adding this after JSExample above</span>

    <span class="token function-variable function">JSCallbackExample</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> <span class="token function-variable function">callback</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Received a callback!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> ptr<span class="token operator">=</span>Runtime<span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span><span class="token string">'v'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<h2 id="on-the-c%23-side-2">On the C# side <a class="direct-link" href="#on-the-c%23-side-2">#</a></h2>
<p>It's also pretty straightforward on the C# side if you let it auto-marshal the pointer as a delegate.</p>
<pre class="language-cs"><code class="language-cs"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"__Internal"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name">Action</span> <span class="token function">JSCallbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExampleUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Action</span> a <span class="token operator">=</span> <span class="token function">JSCallbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>You can also manually marshal it:</p>
<pre class="language-cs"><code class="language-cs"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"__Internal"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name">IntPtr</span> <span class="token function">JSCallbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Action</span> <span class="token function">GetJSCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">IntPtr</span> ptr<span class="token operator">=</span> <span class="token function">JSCallbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Action</span> a<span class="token operator">=</span> Marshal<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetDelegateForFunctionPointer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="on-the-unity-side">On The Unity side <a class="direct-link" href="#on-the-unity-side">#</a></h2>
<p>If you immediately tried to Build and run using your brand new JS Callbacks, you'll get a javascript error. Something along the lines of &quot;Could not find function&quot; or &quot;ran out of table space&quot;  in regards to the &quot;addFunction&quot; command. Emscripten keeps an internal table that maps C# delegates to Javascript functions, and by default this is created at build time and is unchangable. So we have to supply a custom argument to the Emscripten tool to enable runtime usage of 'addFunction.'</p>
<p>Create an Editor script and add these lines to it.</p>
<pre class="language-cs"><code class="language-cs"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MenuItem</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"Tools/Set WebGL Args"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetWebGLArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    PlayerSettings<span class="token punctuation">.</span>WebGL<span class="token punctuation">.</span>emscriptenArgs<span class="token operator">=</span><span class="token string">"-s ALLOW_TABLE_GROWTH"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MenuItem</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"Tools/Unset WebGL Args"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetWebGLArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    PlayerSettings<span class="token punctuation">.</span>WebGL<span class="token punctuation">.</span>emscriptenArgs<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This will add a &quot;Tools&quot; submenu to Unity and allow you to change the WebGL arguments sent to Emscripten.<br>
Just run &quot;Tools/Set WebGL Args&quot; once and that's it. Now you should be able to build and use the AddFunction command</p>
<blockquote>
<p>If you fail to build with a &quot;FILE NOT FOUND 'ALLOW_TABLE_GROWTH'&quot; error, that means you are on an older version of Emscripten that does not have this ability. Don't panic.</p>
</blockquote>
<h1 id="pass-a-javascript-callback-to-c%23-(older-versions-of-emscripten)">Pass a Javascript callback to C# (Older versions of Emscripten) <a class="direct-link" href="#pass-a-javascript-callback-to-c%23-(older-versions-of-emscripten)">#</a></h1>
<p>As mentioned before, Emscripten keeps an internal table of what C# delegates map to which Javascript functions. Unfortunately if you are on an older version of Emscripten, you can't add to this table dynamically. There is an easy, if less elegant, solution:  write our own lookup table in Javascript.</p>
<p>We simply create an array in Javascript, store our would-be Javascript functions, pass their index to C#, and then call a Javascript function with that index which fires the JS callback for us.</p>
<h2 id="on-the-c%23-side-3">On the C# side <a class="direct-link" href="#on-the-c%23-side-3">#</a></h2>
<p>This is going to be almost identical to earlier, with the exception of an additional extern function we use for Invoking.</p>
<pre class="language-cs"><code class="language-cs"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"__Internal"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">JSCallbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"__Internal"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InvokeCallback</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExampleUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">int</span></span> cb<span class="token operator">=</span><span class="token function">JSCallbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//do something.....</span>
    <span class="token function">InvokeCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="on-the-javascript-side-2">On the Javascript side <a class="direct-link" href="#on-the-javascript-side-2">#</a></h2>
<p>We're going to make use of Emscripten's &quot;__postset&quot; command, which will emit a string directly into</p>
<pre class="language-js"><code class="language-js">JSCallbackExample__postset<span class="token operator">:</span><span class="token string">'var cbIDs=[];'</span><span class="token punctuation">,</span>
<span class="token function-variable function">JSCallbackExample</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> <span class="token function-variable function">callback</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Received a callback!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> id<span class="token operator">=</span>cbIDs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function-variable function">InvokeCallback</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> callback<span class="token operator">=</span>cbIDs<span class="token punctuation">[</span>cb<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h1 id="call-external-javascript-on-the-web-page">Call external Javascript on the web page <a class="direct-link" href="#call-external-javascript-on-the-web-page">#</a></h1>
<p>This is probably the easiest thing here. Your JSLibs are still JavaScript running in a web browser which means they follow normal conventions. As long as the external JS library you want to use is declared in a <code>&lt;script&gt;</code> tag before the script tag that loads your UnityInstance, it will be accessible.</p>
<p>(index.html)</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> <span class="token function-variable function">TestExternalJS</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"I'm your external function!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>(example.jslib)</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> myLib<span class="token operator">=</span><span class="token punctuation">{</span>
    $dependencies<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">CallExternal</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">TestExternalJS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">autoAddDeps</span><span class="token punctuation">(</span>myLib<span class="token punctuation">,</span><span class="token string">'$dependencies'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mergInto</span><span class="token punctuation">(</span>LibraryManager<span class="token punctuation">.</span>library<span class="token punctuation">,</span>myLib<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h1 id="creating-global-hooks-for-external-javascript-to-use">Creating global hooks for external Javascript to use <a class="direct-link" href="#creating-global-hooks-for-external-javascript-to-use">#</a></h1>
<p>This last part is a combination of everything we've learned so far.  There are many ways to handle this; this is just my preferred style</p>
<p>We create a new script tag to hold a global object. We give the tag an id for easy access later and a &quot;isLoaded&quot; variable for checking.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UnityHooks<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> UnityHooks<span class="token operator">=</span><span class="token punctuation">{</span>
    isLoaded<span class="token operator">:</span><span class="token boolean">false</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>In our JSLib, we add functions to our global object.  It's a good idea to marshal and cache any data you need.   We finish by setting isLoaded to true, and firing a &quot;loaded&quot; event on the script tag itself.  This will allow any external APIs that depend on our Unity hooks to use the standard EventListener system</p>
<pre class="language-js"><code class="language-js"><span class="token function-variable function">SetUpHooks</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        UnityHooks<span class="token punctuation">.</span>cb<span class="token operator">=</span>callback<span class="token punctuation">;</span>
        UnityHooks<span class="token punctuation">.</span><span class="token function-variable function">TestCallback</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> bufferSize <span class="token operator">=</span> <span class="token function">lengthBytesUTF8</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token function">_malloc</span><span class="token punctuation">(</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stringToUTF8</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Runtime<span class="token punctuation">.</span><span class="token function">dynCall</span><span class="token punctuation">(</span><span class="token string">'vi'</span><span class="token punctuation">,</span>UnityHooks<span class="token punctuation">.</span>cb<span class="token punctuation">,</span><span class="token punctuation">[</span>buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        UnityHooks<span class="token punctuation">.</span>isLoaded<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'UnityHooks'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">'loaded'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<h1 id="wrapping-up">Wrapping Up <a class="direct-link" href="#wrapping-up">#</a></h1>
<p>I believe this covers the missing edge cases in the official Unity documentation. Here's a few common pitfalls I've run across that are worth mentioning.</p>
<h2 id="scope-and-closures">Scope and Closures <a class="direct-link" href="#scope-and-closures">#</a></h2>
<p>A pointer to a string passed in as a parameter will get included as the local scope of a closure.  However, the string this pointer refers to may not!  You should marshal any data you need before creating a closure in Javascript.</p>
<h2 id="what-about-passing-objects%3F">What about passing objects? <a class="direct-link" href="#what-about-passing-objects%3F">#</a></h2>
<p>While it is possible, it is a lot of extra work on the Javascript side as there is no automatic Marshalling in Javascript. In C#, you have to use a &quot;struct&quot; with Explicit layout instead of a &quot;class&quot; when you want to pass data to and from Javascript. In Javascript, you'll have to read/write bytes to a data buffer manually to recreate the data object.<br>
<strong>OR</strong><br>
You could just use JSON to easily convert your object(s) to a string and then pass it across. Nice and easy as both Javascript and UnityC# have built in JSON parsers, but this comes at the cost of some extra memory.</p>
<h2 id="using-non-static-callbacks">Using non-static callbacks <a class="direct-link" href="#using-non-static-callbacks">#</a></h2>
<p>So remember earlier when we passed a static C# callback to Javascript?  That's a bit inconvenient. What if we just used a non-static callback?<br>
You'll get the this error in your Javscript console:</p>
<pre class="language-text"><code class="language-text">NotSupportedException: IL2CPP does not support marshaling delegates that point to instance methods to native code.</code></pre>
<p>So you must use static delegates.  However, you can create a look up table to cache these local delegates and just pass an ID value and a static delegate to the Javascript.  This is the exact same logic we used in <a href="#pass-a-javascript-callback-to-c%23-(older-versions-of-emscripten)">Pass a Javascript callback to C# (Older versions of Emscripten)</a> except now you handle it on the C# side instead of the Javascript side.</p>
<p>I wrote a simple <a href="https://gist.github.com/jmschrack/4d1451a0914f210cbe481bcf176891ea">ActionLookUpTable gist on Github</a> that will work for general Interops. It was built with multi-threading in mind, but it won't compile on WebGL unless you remove the System.Threading imports. However, multi-threading isn't an issue on WebGL so it's an easy remove.</p>
<p>Good luck!</p>

</div>


      <a href="/tags/tutorial/" class="tag">tutorial</a>
      <a href="/tags/blog/" class="tag">blog</a>
      <a href="/tags/Unity3D/" class="tag">Unity3D</a>
      <a href="/tags/github/" class="tag">github</a>
<p><a href="/">← Home</a></p>

		</div>
    </main>

    <footer>
      <div class="w3-light-grey w3-container w3-padding-32" style="margin-top:75px;padding-right:58px">
	<p class="w3-right">
	  Powered by <a href="https://www.11ty.dev/" title="11ty" target="_blank" rel="noopener" class="w3-hover-opacity">11ty</a> and <a href="https://www.w3schools.com/w3css/default.asp" title="W3.CSS" target="_blank" rel="noopener" class="w3-hover-opacity"> w3.css </a>
	  </p>
</div>
    </footer>
	<script>
// Script to open and close sidebar
function w3_open() {
  document.getElementById("mySidebar").style.display = "block";
  document.getElementById("myOverlay").style.display = "block";
}
 
function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
  document.getElementById("myOverlay").style.display = "none";
}
</script>
    <!-- Current page: /posts/UnityWebGL/ -->
  </body>
</html>
